<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="images/logo-small.png" type="image/x-icon">

    <title>Documentation - Dynflow</title>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- CSS -->
    <link rel="stylesheet" href="/css/app.css">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
    <link href='http://dynflow.github.io/atom.xml' rel='alternate' title='site_title - Atom' type='application/atom+xml'>
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Dynflow</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="/">About</a></li>
                <li><a href="/documentation/">Documentation</a></li>
                <li><a href="/faq/">FAQ</a></li>
                <li><a href="/media/">Media</a></li>
                <li><a href="/projects/">Related projects</a></li>
                <!--<li class="dropdown">-->
                <!--<a id="drop1" href="/documentation" class="dropdown-toggle" data-toggle="dropdown"-->
                <!--aria-haspopup="true" role="button" aria-expanded="false">-->
                <!--Documentation-->
                <!--<span class="caret"></span>-->
                <!--</a>-->
                <!--<ul class="dropdown-menu" role="menu" aria-labelledby="drop1">-->
                <!--<li role="presentation">-->
                <!--<a role="menuitem" tabindex="-1" href="/documentation/glossary">Glossary</a>-->
                <!--</li>-->
                <!--&lt;!&ndash;<li role="presentation" class="divider"></li>&ndash;&gt;-->
                <!--</ul>-->
                <!--</li>-->
            </ul>
            <!--<ul class="nav navbar-nav navbar-right">-->
            <!--<li><a class="extra" href="/atom.xml">RSS</a></li>-->
            <!--</ul>-->
        </div>
        <!--/.nav-collapse -->
    </div>
</nav>

<div class="container">
    <div class="row">

    
    <div class="col-md-4">
                <div class="toc well" data-spy="affix" data-offset-top="0" data-offset-bottom="0">
          <h4>Table of content</h4>
          <ul>
<li>
<a href="#high-level-overview">High level overview</a>
</li>
<li>
<a href="#glossary">Glossary</a>
</li>
<li>
<a href="#how-to-use">How to use</a>
<ul>
<li>
<a href="#to-be-added">To be added</a>
</li>
<li>
<a href="#action-anatomy">Action anatomy</a>
<ul>
<li>
<a href="#input-and-output">Input and Output</a>
</li>
<li>
<a href="#triggering">Triggering</a>
</li>
<li>
<a href="#planning">Planning</a>
</li>
<li>
<a href="#running">Running</a>
</li>
<li>
<a href="#finalizing">Finalizing</a>
</li>
</ul>
</li>
<li>
<a href="#action-dependencies">Action dependencies</a>
</li>
<li>
<a href="#action-composition">Action composition</a>
</li>
<li>
<a href="#subscriptions">Subscriptions</a>
</li>
<li>
<a href="#suspending">Suspending</a>
</li>
<li>
<a href="#polling">Polling</a>
</li>
</ul>
</li>
<li>
<a href="#how-it-works">How it works</a>
<ul>
<li>
<a href="#to-be-added">To be added</a>
</li>
</ul>
</li>
<li>
<a href="#use-cases">Use cases</a>
</li>
<li>
<a href="#comments">Comments</a>
</li>
</ul>

        </div>

    </div>
    

    <div class="col-md-8">

        <div class="page">
            
            <h1 class="countheads">Documentation</h1>
            

            <h2 id="high-level-overview">High level overview</h2>

<p><em>TODO to be refined</em></p>

<p>Dynflow (<strong>DYN</strong>amic work<strong>FLOW</strong>) is a workflow engine
written in Ruby that allows to:</p>

<ul>
<li>  Keep track of the progress of running processes</li>
<li>  Run the code asynchronously</li>
<li>  Resume the process when something goes wrong, skip some steps when needed</li>
<li>  Detect independent parts and run them concurrently</li>
<li>  Compose simple actions into more complex scenarios</li>
<li>  Extend the workflows from third-party libraries</li>
<li>  Keep consistency between local transactional database and
external services</li>
<li>  Suspend the long-running steps, not blocking the thread pool</li>
<li>  Cancel steps when possible</li>
<li>  Extend the actions behavior with middlewares</li>
<li>  Pick different adapters to provide: storage backend, transactions, or executor implementation</li>
</ul>

<p>Dynflow has been developed to be able to support orchestration of services in the
<a href="http://katello.org">Katello</a> and <a href="http://theforeman.org/">Foreman</a> projects.</p>

<h2 id="glossary">Glossary</h2>

<p><em>TODO to be refined</em></p>

<ul>
<li>  <strong>Action</strong> - building block of execution plans, a Ruby class inherited
from <code>Dynflow::Action</code>, defines code to be run in each phase. </li>
<li>  <strong>Phase</strong> - Each action has three phases: <code>plan</code>, <code>run</code>, <code>finalize</code>.</li>
<li>  <strong>Input/Output</strong> - Each action has one. It&#39;s a <code>Hash</code> of data which is persisted.</li>
<li>  <strong>Execution plan</strong> - definition of the workflow: product of the plan phase</li>
<li>  <strong>Triggering an action</strong> - entering the plan phase, starting with the plan
method of the action. The execution follows immediately.</li>
<li>  <strong>Flow</strong> - definition of the run/finalize phase, holding the information
about steps that can run concurrently/in sequence. Part of execution plan.</li>
<li>  <strong>Executor</strong> - service that executes the run and finalize flows based on
the execution plan. It can run in the same process as the plan phase or in
different process (using the remote executor)</li>
<li>  <strong>World</strong> - the universe where the Dynflow runs the code: it holds all
needed configuration.</li>
</ul>

<h2 id="how-to-use">How to use</h2>

<h3 id="to-be-added">To be added</h3>

<ul>
<li>  Examples

<ul>
<li>  for async operations</li>
<li>  for orchestrating system/ssh calls</li>
<li>  for keeping consistency between local database and external systems</li>
<li>  sub-tasks</li>
</ul></li>
<li>  Creating World (what is executor?)</li>
<li>  Action anatomy

<ul>
<li>  Input/Output</li>
<li>  Phases</li>
</ul></li>
<li>  Action dependencies</li>
<li>  <del>Actions composition</del></li>
<li>  <del>subscribe/plugins</del></li>
<li>  <del>Suspending</del></li>
<li>  <del>Polling action</del></li>
<li>  Console</li>
<li>  Testing</li>
<li>  Error handling

<ul>
<li>  rescue strategy</li>
<li>  resume</li>
</ul></li>
<li>  Development vs production</li>
<li>  Short vs. long running actions</li>
<li>  Middleware

<ul>
<li>  as current user</li>
</ul></li>
<li>  SubTasks</li>
</ul>

<h3 id="action-anatomy">Action anatomy</h3>

<p>Each action can be viewed as a function. It&#39;s planned for execution with 
input, then it&#39;s executed producing output quite possibly having side-effects. 
After that some finalizing steps can be taken. Actions can use outputs of other actions
as parts of their inputs establishing dependency. Action&#39;s state is serialized between each phase
and survives machine/executor restarts.</p>

<p>As lightly touched in the previous paragraph there are 3 phases: planning, running, finalizing.
Planning phase starts by triggering an action.</p>

<h4 id="input-and-output">Input and Output</h4>

<p>Both input and output are <code>Hash</code>es accessible by <code>Action#input</code> and <code>Action#output</code> methods. They
need to be serializable to JSON so it should contain only combination of primitive Ruby types
like: <code>Hash</code>, <code>Array</code>, <code>String</code>, <code>Integer</code>, etc.</p>

<h4 id="triggering">Triggering</h4>

<p>Any action is triggered by calling:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">world_instance</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="no">AnAction</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</code></pre></div>
<p>which starts immediately planning the action in the same thread and returns after planning.</p>

<div class=" alert alert-info">
  <p><strong>Note:</strong> In Foreman and Katello actions are usually triggered by <code>ForemanTask.async_task</code> and
<code>ForemanTasks.async_task</code> so following part is not that important if you are using
<code>ForemanTasks</code>.</p>

</div>

<p><code>World#trigger</code> method returns object of <code>TriggerResult</code> type. Which is 
<a href="http://blog.pitr.ch/projects/algebrick/">Algebrick</a> variant type where definition follows:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">TriggerResult</span> <span class="o">=</span> <span class="no">Algebrick</span><span class="o">.</span><span class="n">type</span> <span class="k">do</span>
  <span class="c1"># Returned by #trigger when planning fails.</span>
  <span class="no">PlaningFailed</span>   <span class="o">=</span> <span class="n">type</span> <span class="p">{</span> <span class="n">fields!</span> <span class="ss">execution_plan_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span> <span class="no">Exception</span> <span class="p">}</span>
  <span class="c1"># Returned by #trigger when planning is successful but execution fails to start.</span>
  <span class="no">ExecutionFailed</span> <span class="o">=</span> <span class="n">type</span> <span class="p">{</span> <span class="n">fields!</span> <span class="ss">execution_plan_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">error</span><span class="p">:</span> <span class="no">Exception</span> <span class="p">}</span>
  <span class="c1"># Returned by #trigger when planning is successful, #future will resolve after</span>
  <span class="c1"># ExecutionPlan is executed.</span>
  <span class="no">Triggered</span>       <span class="o">=</span> <span class="n">type</span> <span class="p">{</span> <span class="n">fields!</span> <span class="ss">execution_plan_id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">future</span><span class="p">:</span> <span class="no">Future</span> <span class="p">}</span>

  <span class="n">variants</span> <span class="no">PlaningFailed</span><span class="p">,</span> <span class="no">ExecutionFailed</span><span class="p">,</span> <span class="no">Triggered</span>
<span class="k">end</span>
</code></pre></div>
<p>If you do not know <code>Algebrick</code> you can think about these as <code>Struct</code>s with types.
You can see how it&#39;s used to distinguish all the possible results 
<a href="https://github.com/theforeman/foreman-tasks/blob/master/lib/foreman_tasks.rb#L20-L32">in ForemanTasks module</a>.</p>

<h4 id="planning">Planning</h4>

<p>Planning follows immediately after action is triggered. Planning always uses the tread 
triggering the action. Planning phase configures actions&#39;s input for run phase.
It starts by executing <code>plan</code> method of the action instance passing in 
arguments from <code>World#trigger method</code></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">world_instance</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="no">AnAction</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="c1"># executes following</span>
<span class="n">an_action</span><span class="o">.</span><span class="n">plan</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1"># an_action is AnAction</span>
</code></pre></div>
<p>By default <code>plan</code> method plans itself if <code>run</code> method is present using first argument as input.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AnAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="nb">self</span><span class="o">.</span><span class="n">input</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">world_instance</span><span class="o">.</span><span class="n">trigger</span> <span class="no">AnAction</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="s1">&#39;nothing&#39;</span>
</code></pre></div>
<p>The above will just plan itself copying input to output in run phase.</p>

<p>In most cases the <code>plan</code> method is overridden to plan self with transformed arguments and/or 
to plan other actions. Let&#39;s look at the argument transformation first:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AnAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">any_array</span><span class="p">)</span>
    <span class="c1"># pick just numbers</span>
    <span class="n">plan_self</span> <span class="ss">numbers</span><span class="p">:</span> <span class="n">any_array</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Number</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># compute sum - simulating a time consuming operation</span>
    <span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="ss">sum</span><span class="p">:</span> <span class="n">input</span><span class="o">[</span><span class="ss">:numbers</span><span class="o">].</span><span class="n">reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:+</span><span class="p">)</span> 
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now let&#39;s see an example with action planning:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">SumNumbers</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
    <span class="n">plan_self</span> <span class="ss">numbers</span><span class="p">:</span> <span class="n">numbers</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="ss">sum</span><span class="p">:</span> <span class="n">input</span><span class="o">[</span><span class="ss">:numbers</span><span class="o">].</span><span class="n">reduce</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:+</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">SumManyNumbers</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
    <span class="c1"># references to planned actions</span>
    <span class="n">planned_sub_sum_actions</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="n">each_slice</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">numbers</span><span class="o">|</span>
      <span class="n">plan_action</span> <span class="no">SumNumbers</span><span class="p">,</span> <span class="n">numbers</span>
    <span class="k">end</span>

    <span class="c1"># prepare array of output references where each points to sum in the </span>
    <span class="c1"># output of particular action</span>
    <span class="n">sub_sums</span> <span class="o">=</span> <span class="n">planned_sub_sum_actions</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">action</span><span class="o">|</span>
      <span class="n">action</span><span class="o">.</span><span class="n">output</span><span class="o">[</span><span class="ss">:sum</span><span class="o">]</span>
    <span class="k">end</span>

    <span class="c1"># plan one last action which will sum the sub_sums</span>
    <span class="c1"># it depends on all planned_sub_sum_actions because it uses theirs outputs</span>
    <span class="n">plan_action</span> <span class="no">SumNumbers</span><span class="p">,</span> <span class="n">sub_sums</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">world_instance</span><span class="o">.</span><span class="n">trigger</span> <span class="no">SumManyNumbers</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</code></pre></div>
<p>Above example will in parallel sum numbers by slices of 10 values: first action sums <code>1..10</code>,
second action sums <code>11..20</code>, ..., tenth action sums <code>91..100</code>. After all sub sums are computed
one final action sums the sub sums into final sum.</p>

<div class=" alert alert-warning">
  <p><strong>Warning:</strong> This example is here to demonstrate the planning abilities. In reality it paralyzation of 
compute intensive tasks does not have a positive effect on Dynflow running on MRI. The pool of
workers may starve. It is not a big issue since Dynflow is mainly used to orchestrate external 
services.</p>

<p><em>TODO add link to detail explanation when available in How it works.</em></p>

</div>

<h4 id="running">Running</h4>

<p><em>TODO</em></p>

<ul>
<li>  does not touches input just uses it</li>
<li>  defines output</li>
</ul>

<h4 id="finalizing">Finalizing</h4>

<p><em>TODO</em></p>

<ul>
<li>  does not touches input or output just uses it</li>
</ul>

<p><em>TODO bellow to be refined</em></p>

<ul>
<li>  input/output</li>
<li>  it&#39;s kind a dirty function</li>
</ul>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># every action needs to inherit from Dynflow::Action</span>
<span class="k">class</span> <span class="nc">Action</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>

  <span class="c1"># OPTIONAL: the input format for the execution phase of this action</span>
  <span class="c1"># (https://github.com/iNecas/apipie-params for more details.</span>
  <span class="c1"># Validations can be performed against this description (turned off</span>
  <span class="c1"># for now)</span>
  <span class="n">input_format</span> <span class="k">do</span>
    <span class="n">param</span> <span class="ss">:id</span><span class="p">,</span> <span class="nb">Integer</span>
    <span class="n">param</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
  <span class="k">end</span>

  <span class="c1"># OPTIONAL: every action can produce an output in the execution</span>
  <span class="c1"># phase. This allows to describe the output.</span>
  <span class="n">output_format</span> <span class="k">do</span>
    <span class="n">param</span> <span class="ss">:uuid</span><span class="p">,</span> <span class="nb">String</span>
  <span class="k">end</span>

  <span class="c1"># OPTIONAL: this specifies that this action should be performed when</span>
  <span class="c1"># AnotherAction is triggered.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subscribe</span>
    <span class="no">AnotherAction</span>
  <span class="k">end</span>

  <span class="c1"># OPTIONAL: executed during the planning phase. It&#39;s possible to</span>
  <span class="c1"># specify explicitly the workflow here. By default it schedules just</span>
  <span class="c1"># this action.</span>
  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">object_1</span><span class="p">,</span> <span class="n">object_2</span><span class="p">)</span>
    <span class="c1"># +plan_action+ schedules the SubAction to be part of this</span>
    <span class="c1"># workflow</span>
    <span class="c1"># the +object_1+ is passed to the +SubAction#plan+ method.</span>
    <span class="n">plan_action</span> <span class="no">SubAction</span><span class="p">,</span> <span class="n">object_1</span>
    <span class="c1"># we can specify, where in the workflow this action should be</span>
    <span class="c1"># placed, as well as prepare the input.</span>
    <span class="n">plan_self</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">object_2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="n">object_2</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># OPTIONAL: run the execution part of this action. Transform the</span>
  <span class="c1"># data from +input+ to +output+. When not specified, the action is</span>
  <span class="c1"># not used in the execution phase.</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">output</span><span class="o">[</span><span class="ss">:uuid</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">input</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">input</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="c1"># OPTIONAL: finalize the action after the execution phase finishes.</span>
  <span class="c1"># in the +input+ and +output+ attributes are available the data from</span>
  <span class="c1"># execution phase. in the +outputs+ argument, all the execution</span>
  <span class="c1"># phase actions are available, each providing its input and output.</span>
  <span class="k">def</span> <span class="nf">finalize</span>
    <span class="nb">puts</span> <span class="n">output</span><span class="o">[</span><span class="ss">:uuid</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="action-dependencies">Action dependencies</h3>

<p><em>TODO</em> explain <code>sequence</code> and <code>concurrence</code></p>

<h3 id="action-composition">Action composition</h3>

<p>Dynflow is designed to allow easy composition of small building blocks
called <code>Action</code>s. Typically there are actions composing smaller pieces 
together and other actions doing actual steps of work as in following
example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CreateInfrastructure</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">plan</span>
    <span class="n">sequence</span> <span class="k">do</span>
      <span class="n">concurrence</span> <span class="k">do</span>
        <span class="n">plan_action</span><span class="p">(</span><span class="no">CreateMachine</span><span class="p">,</span> <span class="s1">&#39;host1&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">)</span>
        <span class="n">plan_action</span><span class="p">(</span><span class="no">CreateMachine</span><span class="p">,</span> <span class="s1">&#39;host2&#39;</span><span class="p">,</span> <span class="s1">&#39;storage&#39;</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">plan_action</span><span class="p">(</span><span class="no">CreateMachine</span><span class="p">,</span>
                  <span class="s1">&#39;host3&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;web_server&#39;</span><span class="p">,</span>
                  <span class="ss">:db_machine</span>      <span class="o">=&gt;</span> <span class="s1">&#39;host1&#39;</span><span class="p">,</span>
                  <span class="ss">:storage_machine</span> <span class="o">=&gt;</span> <span class="s1">&#39;host2&#39;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Action <code>CreateInfrastructure</code> does not have a <code>run</code> method defined, it only
defines <code>plan</code> action where other actions composed together.</p>

<h3 id="subscriptions">Subscriptions</h3>

<p>Even though composing actions is quite ease and allows to decompose
business logic to small pieces it does not directly support extensions
by plugins. For that there are subscriptions.</p>

<p><code>Actions</code> can subscribe from a plugin, gem, any other library to already
loaded <code>Actions</code>, doing so they extend the planning process with self.</p>

<p>Lets look at an example starting by definition of a core action</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># This action can be extended without doing any </span>
<span class="c1"># other steps to support it.</span>
<span class="k">class</span> <span class="nc">ACoreAppAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
    <span class="n">plan_self</span><span class="p">(</span><span class="ss">args</span><span class="p">:</span> <span class="n">arguments</span><span class="p">)</span>
    <span class="n">plan_action</span><span class="p">(</span><span class="no">AnotherCoreAppAction</span><span class="p">,</span> <span class="n">arguments</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="nb">puts</span> <span class="s2">&quot;Running core action: </span><span class="si">#{</span><span class="n">input</span><span class="o">[</span><span class="ss">:args</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="ss">success</span><span class="p">:</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>followed by an action definition defined in a plugin/gem/etc.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">APluginAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="c1"># plan this action whenever ACoreAppAction action is planned</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subscribe</span>
    <span class="no">ACoreAppAction</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="c1"># are same as in ACoreAppAction#plan</span>
    <span class="n">plan_self</span><span class="p">(</span><span class="ss">args</span><span class="p">:</span> <span class="n">arguments</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="nb">puts</span> <span class="s2">&quot;Running plugin action: </span><span class="si">#{</span><span class="n">input</span><span class="o">[</span><span class="ss">:args</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Subscribed actions are planned with same arguments as action they are
subscribing to which is called <code>trigger</code>. Their plan method is called right
after planning of the triggering action finishes.</p>

<p>It&#39;s also possible to access target action and use its output which 
makes it dependent (running in sequence) on triggering action.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
  <span class="n">plan_self</span> <span class="ss">trigger_success</span><span class="p">:</span> <span class="n">trigger</span><span class="o">.</span><span class="n">output</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">run</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="s1">&#39;trigger succeeded&#39;</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">input</span><span class="o">[</span><span class="ss">:trigger_success</span><span class="o">]</span>
<span class="k">end</span>
</code></pre></div>
<p>Subscription is designed for extension by plugins, it should <strong>not</strong> be used
inside a single library/app-module. It would make the process definition 
hard to follow (all subscribed actions would need to be looked up).</p>

<h3 id="suspending">Suspending</h3>

<p>Sometimes action represents tasks taken in different services, 
(e.g. repository synchronization in <a href="http://www.pulpproject.org/">Pulp</a>).
Dynflow tries not to waste computer resources so it offers tools to free 
threads to work on other actions while waiting on external tasks or events.</p>

<p>Dynflow allows actions to suspend and be woken up on external events. 
Lets create a simulation of an external service before showing the example
of suspending action.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AnExternalService</span>
  <span class="k">def</span> <span class="nf">start_synchronization</span><span class="p">(</span><span class="n">report_to</span><span class="p">)</span>
    <span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="nb">sleep</span> <span class="mi">1</span>
      <span class="n">report_to</span> <span class="o">&lt;&lt;</span> <span class="ss">:done</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The <code>AnExternalService</code> can be invoked to <code>start_synchronization</code> and it will
report back a second later to action passed in argument <code>report_to</code>. It sends
event <code>:done</code> back by <code>&lt;&lt;</code> method.</p>

<p>Lets look at an action example.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AnAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="no">EXTERNAL_SERVICE</span> <span class="o">=</span> <span class="no">AnExternalService</span><span class="o">.</span><span class="n">new</span>

  <span class="k">def</span> <span class="nf">plan</span>
    <span class="n">plan_self</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">event</span>
    <span class="k">when</span> <span class="kp">nil</span> <span class="c1"># first run</span>
      <span class="n">suspend</span> <span class="k">do</span> <span class="o">|</span><span class="n">suspended_action</span><span class="o">|</span> 
        <span class="no">EXTERNAL_SERVICE</span><span class="o">.</span><span class="n">start_synchronization</span> <span class="n">suspended_action</span> 
      <span class="k">end</span>
    <span class="k">when</span> <span class="ss">:done</span> <span class="c1"># external task is done</span>
      <span class="n">output</span><span class="o">.</span><span class="n">update</span> <span class="ss">success</span><span class="p">:</span> <span class="kp">true</span>
      <span class="c1"># let the run phase finish normally</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s1">&#39;unknown event&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Which is then executed as follows:</p>

<ol>
<li> <code>AnAction</code> is triggered </li>
<li> It&#39;s planned.</li>
<li> Its <code>run</code> phase begins.</li>
<li> <code>run</code> method is invoked with no event (<code>nil</code>).</li>
<li> Matches with case branch initiating the external synchronization.</li>
<li> Action initializes the synchronization and pass in reference
to suspended_action.</li>
<li> Action is suspended, execution of the run method finishes immediately
after <code>suspend</code> is called, its block parameter is evaluated right after
suspending.</li>
<li> Action is kept on memory to be woken up when events are received but it does not 
block any threads.</li>
<li> Action receives <code>:done</code> event through suspend action reference.</li>
<li> <code>run</code> method is executed again with <code>:done</code> event.</li>
<li> Output is updated with <code>success: true</code> and actions finishes <code>run</code> phase.</li>
<li> There is no <code>finalize</code> phase, action is done.</li>
</ol>

<p>This event mechanism is quite flexible, it can be used for example to build a 
<a href="https://github.com/Dynflow/dynflow/blob/master/lib/dynflow/action/polling.rb">polling action abstraction</a>
which is a topic for next chapter.</p>

<h3 id="polling">Polling</h3>

<p>Not all services support callbacks to be registered which would allow to wake up suspended
actions only once at the end when the external task is finished. In that case we often 
need to poll the service to see if the task is still running or finished.</p>

<p>For that purpose there is <code>Polling</code> module in Dynflow. Any action can be turned into a polling one
just by including the module.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AnAction</span> <span class="o">&lt;</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span>
  <span class="kp">include</span> <span class="no">Dynflow</span><span class="o">::</span><span class="no">Action</span><span class="o">::</span><span class="no">Polling</span>
</code></pre></div>
<p>There are 3 methods need to be always implemented:</p>

<ul>
<li>  <code>done?</code> - determines when the task is complete based on external task&#39;s data.</li>
<li>  <code>invoke_external_task</code> - starts the external task.</li>
<li>  <code>poll_external_task</code> - polls the external task status data and returns a status 
(JSON serializable data like: <code>Hash</code>, <code>Array</code>, <code>String</code>, etc.) which are stored in action&#39;s
output.</li>
</ul>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">done?</span>
    <span class="n">external_task</span><span class="o">[</span><span class="ss">:progress</span><span class="o">]</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">invoke_external_task</span>
    <span class="n">triger_the_task_with_rest_call</span>  
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">poll_external_task</span>
    <span class="n">data</span>     <span class="o">=</span> <span class="n">poll_data_with_rest_call</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">calculate_progress</span> <span class="n">data</span> <span class="c1"># =&gt; a float in 0..1  </span>
    <span class="p">{</span> <span class="ss">progress</span><span class="p">:</span> <span class="n">progress</span>
      <span class="ss">data</span><span class="p">:</span>     <span class="n">data</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This action will do following in run phase:</p>

<ol>
<li> <code>invoke_external_task</code> on first run of the action</li>
<li> suspends and then periodically:

<ol>
<li> wakes up</li>
<li> <code>poll_external_task</code></li>
<li> checks if <code>done?</code>: 

<ul>
<li><code>true</code> -&gt; it concludes the run phase</li>
<li><code>false</code> -&gt; it schedules next polling</li>
</ul></li>
</ol></li>
</ol>

<p>There are 2 other methods handling external task data which can optionally overridden:</p>

<ul>
<li>  <code>external_task</code> - reads the external task&#39;s stored data, by default it reads <code>self.output[:task]</code></li>
<li>  <code>external_task=</code> - writes the the external task&#39;s stored data, by default it writes to 
<code>self.output[:task] = value</code></li>
</ul>

<p>There are also other features implemented like:</p>

<ul>
<li>  Gradual prolongation of the polling interval.</li>
<li>  Retries on a poll failing.</li>
</ul>

<p>Please see the 
<a href="https://github.com/Dynflow/dynflow/blob/master/lib/dynflow/action/polling.rb"><code>Polling</code> module</a>
for more details.</p>

<h2 id="how-it-works">How it works</h2>

<h3 id="to-be-added">To be added</h3>

<ul>
<li>  Action states</li>
<li>  inter-worlds communication / multi-executors</li>
<li>  Links to concurrent-ruby/algebrick</li>
<li>  Thread-pools</li>
<li>  Suspending -&gt; events</li>
</ul>

<h2 id="use-cases">Use cases</h2>

<p><em>TODO</em></p>

<ul>
<li>  Embedded without a DB, like inside CLI tool for a complex installation</li>
<li>  reserve resources in planning do not try to do <code>if</code>s in run phase</li>
</ul>

<h2 id="comments">Comments</h2>

<p><strong>Comments are temporally turned on here for faster feedback.</strong></p>

        </div>

        

        
        <div id="disqus_thread" aria-live="polite">
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments
                powered by
                Disqus.</a></noscript>
        </div>
        

    </div>
</div>




</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/bootstrap/js/bootstrap.min.js"></script>


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60290609-1', 'auto');
    ga('send', 'pageview');

</script>


<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'dynflow'; // required: replace example with your forum shortname
    var disqus_identifier = 'http://dynflow.github.io/documentation/index.html';
    var disqus_url = 'http://dynflow.github.io/documentation/index.html';
    var disqus_title = 'Dynflow';

    if ('true' == 'true')
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    else
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());

</script>

<script type="text/javascript">
    (function () {
        var twitterWidgets = document.createElement('script');
        twitterWidgets.type = 'text/javascript';
        twitterWidgets.async = true;
        twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
        document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
</script>

<!-- Place this tag in your head or just before your close body tag. -->
<script src="https://apis.google.com/js/platform.js" async defer></script>


<script type="text/javascript">
    $().ready(function () {
        $('.toc a').on('click', function (e) {
            var target = $(this).attr('href');
            $('html,body').animate({scrollTop: $(target).offset().top - 70}, 'normal');
            e.preventDefault();
        });
    });
</script>

</body>
</html>


